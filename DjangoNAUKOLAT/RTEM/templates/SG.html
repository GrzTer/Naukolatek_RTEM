<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <title>Energy Data Chart</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" href="{% static 'main.css' %}">
</head>
<body>

    <header class="header">
        {% include 'Navbar.html' %}
    </header>

    <div class="container mt-5">
        <h2>Select Time Span</h2>
        <div class="btn-group" role="group" aria-label="Time Span Selection">
            <button type="button" class="btn btn-primary" onclick="updateTimeSpan('year')">Year</button>
            <button type="button" class="btn btn-primary" onclick="updateTimeSpan('quarter')">Quarter</button>
            <button type="button" class="btn btn-primary" onclick="updateTimeSpan('month')">Month</button>
            <button type="button" class="btn btn-primary" onclick="updateTimeSpan('week')">Week</button>
        </div>

        <!-- Dynamic form inputs will be injected here -->
        <div id="additionalInputs" class="my-3"></div>

        <!-- Existing form to submit requests -->
        <form method="post" class="mb-3" id="dataForm">
            {% csrf_token %}
            <div class="mb-3">
                <label for="country_code" class="form-label">Country Code:</label>
                <input type="text" class="form-control" name="country_code" id="country_code" required>
            </div>
            <button type="submit" class="btn btn-success">Get Data</button>
        </form>
    </div>
    <div class="container mt-5">
        <div id="energyChart"></div>
    </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const chartData = JSON.parse('{{ prices_chart|safe }}' || '[]').map(item => ({
        x: new Date(item.date),
        y: item.price,
    }));
    initializeBarChart(chartData, '{{ currency }}');
});

function updateTimeSpan(span) {
    const additionalInputs = document.getElementById('additionalInputs');
    let inputHtml = '';
    if (span === 'quarter') {
        inputHtml = `<label for="quarterSelect">Select Quarter:</label>
                     <select class="form-control" id="quarterSelect" name="quarter">
                         <option value="1">Q1</option>
                         <option value="2">Q2</option>
                         <option value="3">Q3</option>
                         <option value="4">Q4</option>
                     </select>`;
    } else if (span === 'month') {
        inputHtml = `<label for="monthSelect">Select Month:</label>
                     <select class="form-control" id="monthSelect" name="month">
                         <option value="1">January</option>
                         <option value="2">February</option>
                     </select>`;
    } else if (span === 'week') {
        inputHtml = `<label for="weekSelect">Select Week:</label>
                     <input type="week" class="form-control" id="weekSelect" name="week">`;
    }
    additionalInputs.innerHTML = inputHtml;
}

document.getElementById('dataForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch('energy_prices.csv', {
        method: 'POST',
        body: formData
    }).then(response => response.json())
    .then(data => {
        const updatedChartData = data.map(item => ({
            x: new Date(item.date),
            y: item.price,
        }));
        updateBarChart(updatedChartData);
    }).catch(error => console.error('Error fetching data:', error));
});

let chart;
function initializeBarChart(chartData, currency) {
    const options = {
        chart: {
            type: 'bar',
            height: 350,
            events: {
                click: function(chart, w, e) {
                }
            }
        },
        series: [{
            name: `Price in ${currency}`,
            data: chartData
        }],
        xaxis: {
            type: 'datetime',
            labels: {
                datetimeUTC: false,
                datetimeFormatter: {
                    year: 'yyyy',
                    month: 'MMM \'yy',
                    day: 'dd MMM',
                    hour: 'HH:mm'
                }
            }
        },
        tooltip: {
            x: {
                format: 'dd MMM yyyy'
            },
            y: {
                formatter: function (val) {
                    return `${val} ${currency}`
                }
            }
        },
        plotOptions: {
            bar: {
                horizontal: false,
                columnWidth: '55%',
                endingShape: 'rounded'
            },
        },
        dataLabels: {
            enabled: false
        },
        stroke: {
            show: true,
            width: 2,
            colors: ['transparent']
        },
        yaxis: {
            title: {
                text: `Price (${currency})`
            },
        },
        fill: {
            opacity: 1
        }
    };

    chart = new ApexCharts(document.querySelector("#energyChart"), options);
    chart.render();
}

function updateBarChart(chartData) {
    chart.updateSeries([{
        data: chartData
    }]);
}
</script>


    <div>
        {% include 'Footer.html' %}
    </div>
</body>
</html>
